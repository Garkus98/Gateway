[[toc]]
# Поддержка lua скриптов (Draft)

## Введение
Шлюз SLS самодостаточен и может обходиться без внешних систем управления Умным домом. Для реализации автоматизаций, он поддерживает скриптовый язык программирования [LUA](https://ru.wikipedia.org/wiki/Lua).
При разработке скриптов можно использовать функции как встроенные в прошивку шлюза, так и функции поддерживаемых шлюзом библиотек LUA.
<!--	#ToDo - какие библиотеки встроены в прошивку
		известны из доков:
		os
		string
		...
 -->
Текущая, поддерживаемая, версия [LUA 5.4.4](https://www.lua.org/versions.html#5.4).
## Соглашения
Немного о форматировании и названиях различных объектов шлюза.

Для работы с различными объектами используется формат кода типа `zigbee.getStatus()`. В терминологии LUA это выглядит как `библиотека.функция()`. Поэтому постараемся придерживаться подобного именования объектов SLS.

Форматирование текста:
- пункты меню: *File -> Save* 
- небольшие куски кода: `print(a)`
- многострочный код:
```lua
local var = 0
print(var)
```
>let's begin
## Примеры скриптов
Все примеры скриптов собраны [здесь](/lua_doc/luaExamples.md)

## Редактор скриптов и отладка
Редактор скриптов, по совместительству с файловым менеджером предназначен для создания, удаления и редактирования файлов, в том числе и скриптов. 
Найти его можно в меню *Actions -> Files* (в старых версиях прошивки *Actions -> Scripts*).<!--	#ToDo - с какой версии прошивки? -->
![](/img/luaScriptEditor.png)
Редактор разделен на несколько областей:
- Меню, с кнопками:
  - *Toggle files* - скрыть / отобразить панель файлов
  - *Save* - сохранить
  - *Run* - запустить скрипт на исполнение
  - *Clear output* - очистить панель вывода
- Панель *Files*. Позволяет управлять файлами:
  - Создать - *New file*
  - Удалить - значок корзины напротив имени каждого файла
  - Открыть на редактирование - каждый файл представляет собой ссылку, по которой файл открывается в панели редактора
- Панель редактора
- Панель вывода - консоль для вывода результатов работы редактируемого скрипта

Скриптовый `stdout` функции LUA `print()` выводит информацию на Панель вывода, а также в системный лог (меню *Log*) шлюза. Данную функцию удобно использовать для отладки.

Для разработки или отладки скрипта, необходимо создать новый файл или открыть существующий. Например, с именем `test.lua` и в него ввести код на языке LUA. 

Отладка скриптов выполняется преимущественно в Редакторе скриптов SLS. Однако, некоторые пользовательские функции может быть удобнее разрабатывать во "взрослых" IDE. Например, нативный [ZeroBrain Studio](https://studio.zerobrane.com), VS Code, Atom и других. 

## Запуск скриптов
В зависимости от задач, выполняемых той или иной автоматизацией, доступны несколько вариантов запуска скриптов:
1. [из скрипта инициализации](/lua_doc/luaDoc.md#скрипт-инициализации)
2. [при изменении состояния устройства](/lua_doc/luaDoc.md#запуск-скрипта-при-изменении-состояния-устройства)
3. [по событию изменения объекта](luaDoc.md#запуск-скрипта-по-событию-изменения-объекта) <!--	#ToDo - в документации вендора данный пункт ссылается на несуществующий раздел? -->
4. [запуск из другого скрипта](luaDoc.md#запуск-lua-скрипта-из-другого-скрипта)
5. [с помощью  http api](luaDoc.md#запуск-скрипта-с-помощью-http-api)
6. [периодический запуск (таймеры)](luaDoc.md#периодический-запуск-скриптов-таймеры)
7. по подписке mqtt (в разработке).

### Скрипт инициализации
При запуске системы выполняется скрипт инициализации `init.lua`, если он есть. Перед началом работы со скриптами, рекомендуется проверить его наличие рядом со всеми остальными скриптами `*.lua`. Если файла нет, то его нужно в редакторе скриптов.  В `init.lua` полезно инициализировать переменные для работы с устройством, а также выполнить какие либо действия. [Например:](/lua_doc/luaExamples.md#скрипт-инициализации)
```lua
-- init.lua --
-- Уведомление в Telegram о старте шлюза --
telegram.settoken("51778***5:AAG0bvK***")
telegram.setchat("-3348***")
telegram.send("SLS загружен!!!")
```

### Запуск скрипта при изменении состояния устройства
Скрипт можно запускать как одно из правил [SimpleBind](/simplebind_rus.md).

Синтаксис: `scriptname.lua[,Param]`

Например, так может выглядеть запись SB Rule для датчика открытия ![](/img/luaSBRule.png)
- `mainDoorOnLight.lua` - имя запускаемого скрипта
- `Param` - необязательный параметр, через который в скрипт можно передать необходимые аргументы. Принимается он в скрипте через Событие `Event.Param`
<!--	#ToDo - добавить ссылку на описание событий -->
Аргументов может быть несколько. В данном примере передается 3 аргумента, разделенные символом `:`: целевое устройство, которым должен управлять датчик по сработке; контролируемый статус; задержка управляющего действия. Если аргументы не прописывать, то при изменении условий, придется менять эти значения в теле скрипта. Пример похожего скрипта [здесь](/lua_doc/luaMainDoorLight.md)

### Запуск скрипта по событию изменения объекта
Синтаксис: `obj.onChange('objName', 'script.lua')`
- `objName` - имя контролируемого объекта
- `script.lua` - имя скрипта, вызываемого при возникновении события

[Например](/lua_doc/luaExamples.md#Включение-режима-сопряжения-по-нажатию-на-кнопку-шлюза), можно вызвать скрипт по событию нажатия аппаратной кнопки шлюза. Реагировать можно на объекты `io.input0.*`. Включим "режим сопряжения" по нажатию на кнопку:
1. в `init.lua` добавить код: `obj.onChange("io.input0.value", "btn_sw1.lua")`
2. создать `btn_sw1.lua` с кодом: `zigbee.join(255, "0x0000")`
<!--	#ToDo - добавить ссылку на описание join  -->
 
### Запуск LUA скрипта из другого скрипта

Синтаксис: `dofile("/int/test.lua")`
<!-- ToDo добавить параметры, если они есть -->

### Запуск скрипта с помощью HTTP API

Скрипт SLS можно вызвать из внешней системы используя [HTTP API](/http_api_rus.md):
`/api/scripts?action=evalFile&path=/test.lua`

### Периодический запуск скриптов из планировщика
Шлюз может запускать скрипты с определенной периодичностью. Можно установить таймер запуска к любому скрипту, а так же отменить его. Дискретность таймеров 1 секунда, для cron - 1 минута.

Типы таймеров:
- Периодический. Выполняется каждые `X` секунд. `Event.Type = 5`
  - Синтаксис: `scripts.setTimer("script", t[, Param])`
- Однократный.  Выполняется однократно в UNIX время. `Event.Type = 4`
  - Синтаксис: `scripts.setTimer("script", os.time() + t[, Param])`
- Cron. `Event.Type = 6`. Добавлен в версии прошивки от 2022.04.24d11
  - Синтаксис как у [UNIX cron](https://ru.wikipedia.org/wiki/Cron) 
- где:
  - `script` - имя файла скрипта, без расширения `lua`
  - `t` - уставка времени в сек. Для сброса таймера: `t = 0`
  - `Param` - параметры передаваемые в скрипт

Примеры:

Запуск скрипта каждые 60 секунд:
```lua
scripts.setTimer("getMoney", 60, "$")
```
Запуск скрипта через 5 минут, однократно:
```lua
scripts.setTimer("giveMoney", os.time() + 300)
```
Запуск скрипта каждый день в 01:05:
```lua
scripts.setTimer("earnMoney", "5 1 * * *")
```
Сброс таймера для скрипта OneMinTimer.lua:
```lua
scripts.setTimer("OneMinTimer", 0)
```
Если все 4 примера выполнить подряд для одного скрипта, то настройка применяется из последней команды. В нашем случае таймер будет отключен. 

Например, скрипт привязан к датчику движения и при каждой сработке настраивает однократный таймер запуска исполняющего скрипта. При этом, если скрипт успевает запуститься несколько раз до сработки таймера, то уставка времени будет из последней итерации. 

:warning: **Внимание, скрипты OneMinTimer.lua и OneSecTimer.lua более не запускаются автоматически!!!**