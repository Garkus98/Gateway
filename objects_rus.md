# Объекты

Объекты это универсальная сущность для хранения и обмена данными между подсистемами шлюза, например между скриптами.

Доступ к объекту осуществляется по его имени.

## Веб интерфейс
Просмотреть текущие объекты можно на странице Objects (*/objects*).

## Сетевые объекты
Используются для синхронизации данных между несколькими шлюзами, при изменении объекта на одном, он так же изенится и на остальных шлюзах.

Данный функционал в разработке.

## MQTT
Шлюз может слать уведомления в MQTT при изменении объекта, это включается через 3 параметр *obj.setOpt()*.

Шлюз будет публиковать в топик вида: *zgwXXXX/obj/OBJ_NAME*

Для изменения объекта необходимо отправить значение объекта в топик *zgwXXXX/obj/OBJ_NAME/set*

Для запроса текущего значения объекта необходимо отправить пустой топик *zgwXXXX/obj/OBJ_NAME/get*

## Сохранение объектов
В данный момент объекты хранятся только в памяти и не сохраняются в флеш-память. 

Для инициализации начальными значениями, можно использовать файл *init.lua*.

## Типы данных
Можно установить объекту тип данных:
* STR - Строки (используется по умолчанию)
* BOOL - Бинарный (true / false)
* INT - Целое число
* FLOAT - Дробное число

## Обратная связь
Объекты поддерживают установку флага обратной связи, таким образом можно различать команду и обратную связь по ней в одном объекте.

Флаг обратной связи виден в веб-интерфейсе (A), а так же 3-й параметр который возвращает obj.get().

Установить флаг можно передав true как 3-й параметр в obj.set()

## Работа с объектами из скриптов

Получение флага обратной связи, значения (текущего и предыдущего) объекта и проверка его существования:
```lua
local current_status, previous_status, ack = obj.get("security.status")
if (current_status == nil) then current_status = 0 end
```

Установка значения объекта:
```lua
obj.set(ObjectName, ObjectValue)
```

Установка значения объекта с отметкой обратной связи:
```lua
obj.set("room_setpoint", 24, true)
```

Удаление объекта:
```lua
obj.remove(ObjectName)
```

Для изменения типа переменной сохраняемого значения можно сделать так:
```lua
obj.setOpt("security.status", "INT")
```

Включение уведомления об изменении в MQTT:
```lua
obj.setOpt("security.status", "INT", true)
```

Получение времени события в секундах lua list (curr,prev):
```lua
local curr, prev = obj.getTime("security.status")
print("Время предыдущего изменения:" .. prev .. ", И последнего: " .. curr .. " длительность события: " .. curr-prev)
```

Привязка к объекту скрипта, который запускается по изменению:
```lua
obj.onChange('room1.temperature', 'room1_trv_calibration.lua')
```

## События
При вызове скрипта привязанного к объекту вызывается событие с типом *SCRIPT_EVENT_TYPE_OBJ_CHANGE* и значением 2 (с версии 2022.01.13d11).

Так же передается имя объекта, его текущее и предыдущее значение.

```lua
if Event.Type == 2 then
  local Name = Event.Obj.Name
  local Value = Event.Obj.Value
  local OldValue = Event.Obj.OldValue
  
  ...
end
```
