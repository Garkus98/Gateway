# Объекты

Объекты это универсальная сущность для хранения и обмена данными между подсистемами шлюза, например между скриптами.

Доступ к объекту осуществляется по его имени.

## Веб интерфейс
Просмотреть текущие объекты можно на странице Objects (*/objects*).

## Сохранение объектов
В данный момент объекты хранятся только в памяти и не сохраняются в флеш-память. 

Для инициализации начальными значениями, можно использовать файл *init.lua*:
```lua
obj.setOpt("security.status", "BOOL")
```

Третий параметр является опциональным, при передаче true  включается отправка  уведомления в MQTT:
```lua
obj.setOpt("security.status", "BOOL", true)
```

**Типы данных**
Можно установить объекту тип данных:
* STR - Строки (используется по умолчанию)
* BOOL - Бинарный (true / false)
* INT - Целое число
* FLOAT - Дробное число

При изменении значения объекта можно вызвать  lua-сценарий, для этого в *init.lua* можно указать 
```lua
obj.onChange('security.status', 'security_event.lua')
```
теперь при изменении значения объекта  security.status будет вызываться скрипт security_event.lua.
Для того, чтобы при изменении значения объекта security.status при установке шлюз не уходил в бесконечный цикл, есть возможность управлять обратной связью.  


## Обратная связь при изменении значения объектов
Объекты поддерживают установку флага обратной связи, таким образом можно в вызываемом скрипте можно получить информацию об источнике изменения. 

Установить флаг можно передав true как 3-й параметр в *obj.set()*

Флаг обратной связи виден в веб-интерфейсе (A), а так же 3-й параметр который возвращает *obj.get()*.

При запуске привязанного к объекту скрипта, флаг так же передается содержится в *Event.Obj.Ack*

## Работа с объектами из скриптов

Получение флага обратной связи, значения (текущего и предыдущего) объекта и проверка его существования:
```lua
local current_status, previous_status, ack = obj.get("security.status")
if (current_status == nil) then current_status = 0 end
```

Установка значения объекта:
```lua
obj.set(ObjectName, ObjectValue)
```

Установка значения объекта с отметкой обратной связи:
```lua
obj.set("room_setpoint", 24, true)
```

Удаление объекта:
```lua
obj.remove(ObjectName)
```

Для изменения типа переменной сохраняемого значения можно сделать так:
```lua
obj.setOpt("security.status", "INT")
```

Включение уведомления об изменении в MQTT:
```lua
obj.setOpt("security.status", "INT", true)
```

Получение времени события в секундах lua list (curr,prev):
```lua
local curr, prev = obj.getTime("security.status")
print("Время предыдущего изменения:" .. prev .. ", И последнего: " .. curr .. " длительность события: " .. curr-prev)
```

Привязка к объекту скрипта, который запускается по изменению:
```lua
obj.onChange('room1.temperature', 'room1_trv_calibration.lua')
```

## События
При вызове скрипта привязанного к объекту вызывается событие с типом *SCRIPT_EVENT_TYPE_OBJ_CHANGE* и значением 2 (с версии 2022.01.13d11).

Так же передается имя объекта, его текущее и предыдущее значение, флаг обратной связи.

```lua
if Event.Type == 2 then
  local Name = Event.Obj.Name
  local Value = Event.Obj.Value
  local OldValue = Event.Obj.OldValue
  local Ack = Event.Obj.Ack
  
  ...
end
```


## MQTT
Шлюз может отправлять уведомления в MQTT при изменении объекта, это включается через 3 параметр *obj.setOpt()*.

Шлюз будет публиковать в топик вида: *zgwXXXX/obj/OBJ_NAME*

Для изменения объекта необходимо отправить значение объекта в топик *zgwXXXX/obj/OBJ_NAME/set*

Для запроса текущего значения объекта необходимо отправить пустой топик *zgwXXXX/obj/OBJ_NAME/get*

## Сетевые объекты
Используются для синхронизации данных между несколькими шлюзами, при изменении объекта на одном, он так же изенится и на остальных шлюзах.

Данный функционал в разработке.
